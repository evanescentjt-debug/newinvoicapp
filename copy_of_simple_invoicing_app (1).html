<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Full-Feature Invoicing App</title>
  <!-- Libraries for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js" integrity="sha512-YcsIP+Y0f8xY5Y1m1k3m5Yq4mX6nQZc3s1q3K0l5oY1+6Kf7mZ2mPq9g5oJ2s4KJ1b7fQJrXQZQ2Z6Y1bQZ2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root{
      --bg:#f5f5f5; --card:#fff; --text:#111; --muted:#666; --accent:#007bff;
    }
    [data-theme="dark"]{ --bg:#0f1724; --card:#0b1220; --text:#e6eef6; --muted:#9aa7bd; --accent:#60a5fa }
    *{box-sizing:border-box}
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:var(--text);margin:18px}
    .app{max-width:1000px;margin:auto;background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 22px rgba(2,6,23,0.12)}
    header{display:flex;align-items:center;gap:16px}
    .logo-preview{width:90px;height:60px;border-radius:8px;object-fit:contain;background:#fff;border:1px dashed #ccc;padding:6px}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
    input,select,textarea{padding:8px;border-radius:6px;border:1px solid #ccc;background:transparent;color:var(--text)}
    label{font-size:13px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:12px}
    .col-4{grid-column:span 4}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #d3dce6;padding:8px;text-align:left}
    th{background:transparent}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .actions{margin-top:12px;display:flex;gap:8px}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer}
    .btn.secondary{background:#6b7280}
    .totals{margin-top:12px;display:flex;justify-content:flex-end;gap:18px;flex-direction:column}
    .toggle{display:flex;gap:6px;align-items:center}
    .small{font-size:13px}
    .product-select{width:100%}
    .footer-note{font-size:13px;color:var(--muted);margin-top:12px}
    @media (max-width:760px){.grid{grid-template-columns:repeat(6,1fr)} .col-8{grid-column:span 6} .col-4{grid-column:span 6}}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div>
        <input type="file" id="logoInput" accept="image/*" />
        <img id="logoPreview" class="logo-preview" alt="logo preview" />
      </div>
      <div>
        <h2 contenteditable id="companyName">Your Company Name</h2>
        <div class="muted small" contenteditable id="companyAddress">Company address, phone, email</div>
      </div>

      <div class="controls">
        <div class="toggle small">
          <label for="darkMode">Dark</label>
          <input type="checkbox" id="darkMode" />
        </div>
        <button class="btn" id="addProductBtn">Add Product</button>
      </div>
    </header>

    <section class="grid">
      <div class="col-6">
        <label>Bill To</label>
        <textarea id="customerInfo" rows="4" placeholder="Customer name
Address
Contact"></textarea>
      </div>
      <div class="col-6">
        <label>Invoice #</label>
        <input id="invoiceNumber" />
        <label>Invoice Date</label>
        <input id="invoiceDate" type="date" />
        <label>Payment Terms</label>
        <input id="paymentTerms" placeholder="e.g. Net 14" />
      </div>

      <div class="col-12">
        <label>Products / Items</label>
        <table id="itemsTable">
          <thead>
            <tr>
              <th style="width:30%">Item</th>
              <th style="width:12%">Unit Price</th>
              <th style="width:10%">Qty</th>
              <th style="width:12%">Line Discount (%)</th>
              <th style="width:12%">Tax %</th>
              <th style="width:12%">Line Total</th>
              <th style="width:12%"></th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
        <div class="actions">
          <select id="productDropdown" class="product-select"></select>
          <button class="btn secondary" onclick="addRowFromDropdown()">Add Selected</button>
          <button class="btn" onclick="addEmptyRow()">Add Blank Item</button>
        </div>
      </div>

      <div class="col-4">
        <label>Delivery Charge</label>
        <input id="deliveryCharge" type="number" step="0.01" value="0" oninput="recalc()" />

        <label>Discount (overall %, optional)</label>
        <input id="overallDiscount" type="number" step="0.01" value="0" oninput="recalc()" />
      </div>

      <div class="col-4">
        <label>Tax (overall %, optional)</label>
        <input id="overallTax" type="number" step="0.01" value="0" oninput="recalc()" />

        <label>Currency</label>
        <select id="currencySelect" onchange="recalc()">
          <option value="TTD|1|TT$">Trinidad & Tobago (TTD)</option>
          <option value="USD|1|$">USD (manual rate)</option>
          <option value="EUR|1|€">EUR (manual rate)</option>
        </select>
        <label>Exchange rate (1 unit of selected currency = X base currency)</label>
        <input id="exchangeRate" type="number" step="0.0001" value="1" oninput="recalc()" />
      </div>

      <div class="col-4">
        <label>Notes / Terms</label>
        <textarea id="notes" rows="5" placeholder="Notes or payment instructions"></textarea>

        <div style="margin-top:8px">
          <button class="btn" onclick="saveInvoice()">Save Invoice</button>
          <button class="btn" onclick="exportJSON()">Export JSON</button>
          <button class="btn" onclick="downloadPDF()">Save as PDF</button>
          <button class="btn secondary" onclick="printInvoice()">Print</button>
        </div>
      </div>

      <div class="col-12 totals" id="totalsArea">
        <div class="small muted">Subtotal: <span id="subtotal">0.00</span></div>
        <div class="small muted">Delivery: <span id="deliveryDisplay">0.00</span></div>
        <div class="small muted">Overall Discount: <span id="overallDiscountDisplay">0.00</span></div>
        <div class="small muted">Overall Tax: <span id="overallTaxDisplay">0.00</span></div>
        <h3 class="right">Grand Total: <span id="grandTotal">0.00</span></h3>
        <div class="small muted">Currency Display: <span id="currencySymbol">TT$</span></div>
      </div>

      <div class="col-12">
        <label>Saved Invoices</label>
        <select id="savedInvoices" onchange="loadInvoice()"><option value="">-- Select --</option></select>
        <button class="btn secondary" onclick="clearSaved()">Clear All Saved</button>
      </div>
    </section>

    <div class="footer-note">Tip: click company name or address to edit. Logo preview appears after uploading. You can toggle dark mode. Use the product dropdown to quickly add recurring products.</div>
  </div>

  <script>
    // Data
    const products = [
      {id: 'p1', name: '80pc Domino Train Set', price: 195},
      {id: 'p2', name: 'PS5 Controller', price: 450},
      {id: 'p3', name: 'Art Set (Large)', price: 60},
      {id: 'p4', name: 'LED Strip (5m)', price: 120}
    ];

    // Init
    document.addEventListener('DOMContentLoaded', ()=>{
      initDefaults();
      bindEvents();
      loadSavedList();
      addEmptyRow();
    });

    function initDefaults(){
      document.getElementById('invoiceDate').valueAsDate = new Date();
      document.getElementById('invoiceNumber').value = 'INV' + Date.now();
      const dd = document.getElementById('productDropdown');
      dd.innerHTML = '<option value="">-- Select product --</option>' + products.map(p=>`<option value="${p.id}">${p.name} — ${p.price.toFixed(2)}</option>`).join('');
    }

    function bindEvents(){
      document.getElementById('logoInput').addEventListener('change', handleLogo);
      document.getElementById('darkMode').addEventListener('change', e=>{
        if(e.target.checked) document.documentElement.setAttribute('data-theme','dark'); else document.documentElement.removeAttribute('data-theme');
      });
      document.getElementById('addProductBtn').addEventListener('click', ()=>{
        const name = prompt('Product name');
        const price = parseFloat(prompt('Unit price')); if(!name || isNaN(price)) return;
        const id = 'p' + (products.length+1);
        products.push({id,name,price}); initDefaults();
        alert('Product added to dropdown');
      });
    }

    function handleLogo(e){
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=> document.getElementById('logoPreview').src = reader.result;
      reader.readAsDataURL(file);
    }

    function addRowFromDropdown(){
      const sel = document.getElementById('productDropdown').value; if(!sel) return alert('Select a product');
      const prod = products.find(p=>p.id===sel);
      addItemRow(prod.name, prod.price, 1, 0, 0);
    }

    function addEmptyRow(){ addItemRow('','0.00',1,0,0); }

    function addItemRow(name, price, qty, lineDiscount, tax){
      const tbody = document.getElementById('itemsBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="item-name" value="${escapeHtml(name)}" oninput="recalc()" /></td>
        <td><input class="item-price" type="number" step="0.01" value="${price}" oninput="recalc()" /></td>
        <td><input class="item-qty" type="number" value="${qty}" min="0" oninput="recalc()" /></td>
        <td><input class="item-discount" type="number" step="0.01" value="${lineDiscount}" oninput="recalc()" /></td>
        <td><input class="item-tax" type="number" step="0.01" value="${tax}" oninput="recalc()" /></td>
        <td class="right"><span class="line-total">0.00</span></td>
        <td><button class="btn secondary" onclick="this.closest('tr').remove();recalc()">Remove</button></td>
      `;
      tbody.appendChild(tr);
      recalc();
    }

    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }

    function recalc(){
      const rows = Array.from(document.querySelectorAll('#itemsBody tr'));
      let subtotal = 0;
      rows.forEach(r=>{
        const price = parseFloat(r.querySelector('.item-price').value) || 0;
        const qty = parseFloat(r.querySelector('.item-qty').value) || 0;
        const disc = parseFloat(r.querySelector('.item-discount').value) || 0; // percent
        const tax = parseFloat(r.querySelector('.item-tax').value) || 0; // percent
        let line = price * qty;
        line = line - (line * (disc/100));
        const taxAmt = line * (tax/100);
        const lineTotal = line + taxAmt;
        r.querySelector('.line-total').innerText = lineTotal.toFixed(2);
        subtotal += lineTotal;
      });

      const delivery = parseFloat(document.getElementById('deliveryCharge').value) || 0;
      const overallDisc = parseFloat(document.getElementById('overallDiscount').value) || 0;
      const overallTax = parseFloat(document.getElementById('overallTax').value) || 0;

      const overallDiscountAmount = subtotal * (overallDisc/100);
      const afterDiscount = subtotal - overallDiscountAmount;
      const overallTaxAmount = afterDiscount * (overallTax/100);

      let grand = afterDiscount + overallTaxAmount + delivery;

      // currency exchange
      const cur = document.getElementById('currencySelect').value.split('|');
      const rate = parseFloat(document.getElementById('exchangeRate').value) || 1;
      const symbol = cur[2] || '';
      // exchange rate meaning: 1 selected currency = X base currency (app base). We'll display values in base.
      // For simplicity we don't convert individual line items automatically; we show symbol only and allow rate to scale total.
      document.getElementById('subtotal').innerText = (subtotal/rate).toFixed(2);
      document.getElementById('deliveryDisplay').innerText = (delivery/rate).toFixed(2);
      document.getElementById('overallDiscountDisplay').innerText = overallDiscountAmount ? (overallDiscountAmount/rate).toFixed(2) : '0.00';
      document.getElementById('overallTaxDisplay').innerText = overallTaxAmount ? (overallTaxAmount/rate).toFixed(2) : '0.00';
      document.getElementById('grandTotal').innerText = (grand/rate).toFixed(2);
      document.getElementById('currencySymbol').innerText = symbol;
    }

    function gatherInvoice(){
      const rows = Array.from(document.querySelectorAll('#itemsBody tr'));
      const items = rows.map(r=>({
        name: r.querySelector('.item-name').value,
        price: parseFloat(r.querySelector('.item-price').value) || 0,
        qty: parseFloat(r.querySelector('.item-qty').value) || 0,
        discount: parseFloat(r.querySelector('.item-discount').value) || 0,
        tax: parseFloat(r.querySelector('.item-tax').value) || 0,
        lineTotal: parseFloat(r.querySelector('.line-total').innerText) || 0
      }));

      return {
        id: document.getElementById('invoiceNumber').value,
        date: document.getElementById('invoiceDate').value,
        paymentTerms: document.getElementById('paymentTerms').value,
        customer: document.getElementById('customerInfo').value,
        company: { name: document.getElementById('companyName').innerText, address: document.getElementById('companyAddress').innerText },
        items,
        overallDiscount: parseFloat(document.getElementById('overallDiscount').value) || 0,
        overallTax: parseFloat(document.getElementById('overallTax').value) || 0,
        delivery: parseFloat(document.getElementById('deliveryCharge').value) || 0,
        notes: document.getElementById('notes').value,
        currency: document.getElementById('currencySelect').value,
        exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 1,
        totals: { subtotal: parseFloat(document.getElementById('subtotal').innerText) || 0, grand: parseFloat(document.getElementById('grandTotal').innerText) || 0 }
      };
    }

    function saveInvoice(){
      const inv = gatherInvoice();
      if(!inv.id) return alert('Invoice number required');
      const store = JSON.parse(localStorage.getItem('invoices')||'{}');
      store[inv.id] = inv;
      localStorage.setItem('invoices', JSON.stringify(store));
      loadSavedList();
      alert('Saved locally');
    }

    function loadSavedList(){
      const store = JSON.parse(localStorage.getItem('invoices')||'{}');
      const sel = document.getElementById('savedInvoices');
      sel.innerHTML = '<option value="">-- Select --</option>' + Object.keys(store).map(k=>`<option value="${k}">${k} — ${store[k].date || ''}</option>`).join('');
    }

    function loadInvoice(){
      const id = document.getElementById('savedInvoices').value; if(!id) return;
      const store = JSON.parse(localStorage.getItem('invoices')||'{}');
      const inv = store[id]; if(!inv) return alert('Invoice not found');
      document.getElementById('invoiceNumber').value = inv.id;
      document.getElementById('invoiceDate').value = inv.date;
      document.getElementById('paymentTerms').value = inv.paymentTerms;
      document.getElementById('customerInfo').value = inv.customer;
      document.getElementById('companyName').innerText = inv.company.name;
      document.getElementById('companyAddress').innerText = inv.company.address;
      document.getElementById('deliveryCharge').value = inv.delivery;
      document.getElementById('overallDiscount').value = inv.overallDiscount;
      document.getElementById('overallTax').value = inv.overallTax;
      document.getElementById('notes').value = inv.notes;
      document.getElementById('currencySelect').value = inv.currency;
      document.getElementById('exchangeRate').value = inv.exchangeRate;

      // rebuild rows
      document.getElementById('itemsBody').innerHTML = '';
      inv.items.forEach(it=> addItemRow(it.name,it.price,it.qty,it.discount,it.tax));
      recalc();
    }

    function clearSaved(){ if(confirm('Clear all saved invoices?')){ localStorage.removeItem('invoices'); loadSavedList(); }}

    function exportJSON(){ const inv = gatherInvoice(); const blob = new Blob([JSON.stringify(inv,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = inv.id + '.json'; a.click(); URL.revokeObjectURL(url); }

    function downloadPDF(){
      // prepare a clone to make printable layout clean
      const clone = document.getElementById('app').cloneNode(true);
      // remove controls we don't want
      clone.querySelectorAll('input,button,select,textarea').forEach(n=>n.setAttribute('disabled','true'));
      const opt = {margin:0.5,filename:document.getElementById('invoiceNumber').value + '.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2},jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
      html2pdf().from(clone).set(opt).save();
    }

    function printInvoice(){
      const w = window.open('','_blank');
      const clone = document.getElementById('app').cloneNode(true);
      clone.querySelectorAll('input,button,select,textarea').forEach(n=>n.setAttribute('disabled','true'));
      w.document.body.appendChild(clone);
      w.document.close();
      w.print();
    }
  </script>
</body>
</html>
